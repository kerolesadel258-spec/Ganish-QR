<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>تطبيق الخدمة الذكي - جنش</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --danger: #e74c3c; --success: #27ae60; --bg: #f4f7f6; --white: #ffffff; }
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; color: white; transition: opacity 0.5s ease; }
        .splash-logo { font-size: 80px; margin-bottom: 20px; }
        .splash-text { font-size: 24px; font-weight: bold; }
        .designer-tag { font-size: 18px; color: var(--accent); margin-top: 10px; border-top: 1px solid #ffffff44; padding-top: 10px; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; direction: rtl; user-select: none; -webkit-tap-highlight-color: transparent; }
        .dashboard { text-align: center; padding: 40px 15px; }
        #clock { color: #7f8c8d; font-size: 14px; margin-bottom: 30px; font-weight: bold; }
        .main-buttons { display: grid; gap: 12px; max-width: 100%; margin: auto; }
        .menu-btn { padding: 20px; font-size: 18px; border: none; border-radius: 15px; cursor: pointer; background: var(--primary); color: white; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.3s; }
        .menu-btn:active { transform: scale(0.95); }
        .sync-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; padding: 15px; background: #eef2f3; border-radius: 15px; border: 1px dashed var(--accent); }
        .sync-btn { padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; color: white; }
        .export-btn { background: #8e44ad; }
        .import-btn { background: #27ae60; }
        .alert-btn { background: #d35400; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); overflow-y: auto; }
        .modal-content { background: var(--white); margin: 0 auto; padding: 20px; width: 100%; min-height: 100%; box-sizing: border-box; position: relative; border-radius: 0; }
        .close { position: absolute; left: 15px; top: 15px; font-size: 35px; cursor: pointer; color: #e74c3c; z-index: 1010; font-weight: bold; }
        .table-wrapper { max-height: 40vh; overflow-y: auto; border: 1px solid #ddd; margin-top: 15px; border-radius: 10px; background: white; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px 10px; border-bottom: 1px solid #eee; text-align: right; font-size: 14px; }
        th { background: #f8f9fa; position: sticky; top: 0; color: var(--primary); }
        .del-btn { background: var(--danger); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
        .clear-all-btn { background: #c0392b; color: white; border: none; padding: 12px; border-radius: 10px; margin-top: 20px; cursor: pointer; width: 100%; font-weight: bold; font-size: 14px; }
        .count-badge { background: var(--accent); color: white; padding: 5px 12px; border-radius: 20px; font-size: 14px; margin-bottom: 10px; display: inline-block; }
        .count-link { color: var(--accent); font-weight: bold; background: #e1f5fe; padding: 6px 10px; border-radius: 6px; display: inline-block; cursor: pointer; }
        #reader { width: 100%; background: black; border-radius: 15px; overflow: hidden; min-height: 250px; position: relative; }
        #scanStatus { padding: 15px; text-align: center; margin-top: 10px; font-weight: bold; border-radius: 10px; background: #eee; font-size: 14px; }
        .retry-btn { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 10px; margin-top: 10px; display: none; width: 100%; font-weight: bold; }
        .search-input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-family: inherit; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-logo">⛪</div>
        <div class="splash-text">نظام الخدمة الذكي</div>
        <div class="designer-tag">تصميم ومبرمج التطبيق: جنش</div>
    </div>

    <audio id="successSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <div class="dashboard">
        <header>
            <h1>⛪ تطبيق الخدمة الذكي</h1>
            <p id="clock">جاري التحميل...</p>
        </header>
        <div class="main-buttons">
            <button class="menu-btn" onclick="openModal('addModal')">➕ مخدوم جديد</button>
            <button class="menu-btn" onclick="openModal('scanModal')">📸 تسجيل حضور</button>
            <button class="menu-btn" onclick="openModal('reportModal')">📊 السجل العام</button>
            <button class="menu-btn alert-btn" onclick="openModal('absentModal')">⚠️ الغائبين</button>
        </div>

        <div class="sync-container">
            <button class="sync-btn export-btn" onclick="openSyncModal('EXPORT')">📤 تصدير بيانات</button>
            <button class="sync-btn import-btn" onclick="openSyncModal('IMPORT')">📥 استيراد بيانات</button>
            <div style="grid-column: span 2; font-size: 12px; color: #666; margin-top: 5px;">مركز مزامنة هواتف الخدام</div>
        </div>
    </div>

    <div id="syncModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('syncModal')">&times;</span>
            <h2 id="syncTitle">مزامنة</h2>
            <div style="background:#f9f9f9; padding:20px; border-radius:15px; border:1px solid #ddd;">
                <label id="syncLabel" style="display:block; margin-bottom:10px; font-weight:bold;"></label>
                <input type="date" id="syncDate" class="search-input">
                
                <div id="importSection" style="display:none;">
                    <label style="display:block; margin-bottom:10px; font-weight:bold;">الصق كود المزامنة هنا:</label>
                    <textarea id="syncCodeArea" class="search-input" rows="5" placeholder="ضع الكود هنا..."></textarea>
                </div>

                <button id="syncActionBtn" class="menu-btn" style="width:100%; margin-top:10px;"></button>
            </div>
        </div>
    </div>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addModal')">&times;</span>
            <h2>إضافة مخدوم</h2>
            <input type="text" id="mName" placeholder="الاسم الكامل" class="search-input">
            <input type="tel" id="mPhone" placeholder="رقم التليفون (للكود)" class="search-input">
            <button class="menu-btn" style="background:var(--success); width:100%" onclick="addNewMember()">حفظ وإنشاء QR</button>
            <div id="qrcode" style="display: flex; justify-content: center; padding: 10px; background: white; border-radius: 10px; margin-top: 10px;"></div>
            <h3>قائمة المخدومين</h3>
            <div id="membersCount" class="count-badge">إجمالي المخدومين: 0</div>
            <input type="text" id="searchMembers" onkeyup="renderMembersTable()" placeholder="ابحث في أسماء المخدومين..." class="search-input">
            <div class="table-wrapper"><table id="membersTable"><thead><tr><th>الاسم</th><th>حذف</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <div id="scanModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="stopScanner(); closeModal('scanModal')">&times;</span>
            <h2>📸 تسجيل حضور</h2>
            <input type="date" id="attendanceDate" class="search-input" onchange="loadTodayTable()">
            <div id="reader"></div>
            <div id="scanStatus">جاري تهيئة الكاميرا...</div>
            <button id="retryBtn" class="retry-btn" onclick="startScanner()">🔄 إعادة تشغيل الكاميرا</button>
            <div style="background:#f9f9f9; padding:15px; border-radius:15px; margin-top:15px; border:1px solid #eee;">
                <input type="text" id="manualSearch" onkeyup="filterManualList()" placeholder="بحث بالاسم للتحضير اليدوي..." class="search-input">
                <select id="namesList" size="4" style="width:100%; padding:10px; margin-bottom:10px; border-radius:10px; border:1px solid #ddd;"></select>
                <button class="menu-btn" style="background:var(--success); width:100%;" onclick="registerManual()">✅ تحضير المختار</button>
            </div>
            <h3>حضور اليوم</h3>
            <div id="presentCount" class="count-badge">عدد الحاضرين اليوم: 0</div>
            <input type="text" id="searchToday" onkeyup="loadTodayTable()" placeholder="ابحث في الحاضرين اليوم..." class="search-input">
            <div class="table-wrapper"><table id="todayTable"><thead><tr><th>الاسم</th><th>حذف</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('reportModal')">&times;</span>
            <h2>📊 السجل العام</h2>
            <input type="text" id="searchKey" onkeyup="searchGlobal()" placeholder="بحث في السجل..." class="search-input">
            <div class="table-wrapper"><table id="attendanceTable"><thead><tr><th>الاسم</th><th>التليفون</th><th>الأيام</th><th>حذف</th></tr></thead><tbody></tbody></table></div>
            <button class="clear-all-btn" onclick="clearAttendanceData()">🗑️ مسح السجلات</button>
        </div>
    </div>

    <div id="absentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('absentModal')">&times;</span>
            <h2>قائمة الغائبين</h2>
            <input type="date" id="absentCheckDate" class="search-input" onchange="renderAbsentList()">
            <div id="absentCount" class="count-badge">عدد الغائبين: 0</div>
            <input type="text" id="searchAbsent" onkeyup="renderAbsentList()" placeholder="ابحث في الغائبين..." class="search-input">
            <div class="table-wrapper"><table id="absentTable"><thead><tr><th>الاسم</th><th>التليفون</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <div id="historyModal" class="modal" style="z-index: 1100;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('historyModal')">&times;</span>
            <h2 id="historyOwnerName">التواريخ</h2>
            <div class="table-wrapper"><table id="personDatesTable"><thead><tr><th>التاريخ</th><th>حذف</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <script>
        let html5QrCode;
        let members = JSON.parse(localStorage.getItem('church_members')) || [];
        let attendance = JSON.parse(localStorage.getItem('attendance_data')) || [];
        
        const todayStr = new Date().toISOString().split('T')[0];
        document.getElementById('attendanceDate').value = todayStr;
        document.getElementById('absentCheckDate').value = todayStr;

        window.addEventListener('load', () => {
            setTimeout(() => { 
                document.getElementById('splash-screen').style.opacity = '0'; 
                setTimeout(() => { document.getElementById('splash-screen').style.display = 'none'; }, 500);
            }, 2000);
        });

        function openModal(id) {
            document.getElementById(id).style.display = "block";
            if(id === 'addModal') renderMembersTable();
            if(id === 'scanModal') { loadTodayTable(); filterManualList(); setTimeout(startScanner, 500); }
            if(id === 'reportModal') renderAttendanceSummary(attendance);
            if(id === 'absentModal') renderAbsentList();
        }

        function closeModal(id) { document.getElementById(id).style.display = "none"; }

        // وظائف المزامنة الجديدة
        function openSyncModal(mode) {
            const modal = document.getElementById('syncModal');
            const title = document.getElementById('syncTitle');
            const label = document.getElementById('syncLabel');
            const btn = document.getElementById('syncActionBtn');
            const importSection = document.getElementById('importSection');
            const syncDate = document.getElementById('syncDate');
            
            syncDate.value = new Date().toISOString().split('T')[0];
            modal.style.display = "block";

            if(mode === 'EXPORT') {
                title.innerText = "📤 تصدير حضور يوم";
                label.innerText = "اختر التاريخ الذي تريد تصدير بياناته:";
                importSection.style.display = "none";
                btn.innerText = "نسخ كود التصدير";
                btn.style.background = "#8e44ad";
                btn.onclick = () => {
                    const date = syncDate.value;
                    const records = attendance.filter(a => a.date === date);
                    if(records.length === 0) return alert("لا يوجد حضور مسجل في هذا التاريخ!");
                    const code = btoa(unescape(encodeURIComponent(JSON.stringify(records))));
                    const temp = document.createElement('textarea');
                    document.body.appendChild(temp);
                    temp.value = code;
                    temp.select();
                    document.execCommand('copy');
                    document.body.removeChild(temp);
                    alert("تم نسخ الكود بنجاح! أرسله لزميلك.");
                };
            } else {
                title.innerText = "📥 استيراد بيانات";
                label.innerText = "اختر التاريخ الذي تريد إضافة الحضور إليه:";
                importSection.style.display = "block";
                btn.innerText = "إتمام الاستيراد";
                btn.style.background = "#27ae60";
                btn.onclick = () => {
                    const targetDate = syncDate.value;
                    const code = document.getElementById('syncCodeArea').value.trim();
                    if(!code) return alert("من فضلك الصق الكود أولاً!");
                    try {
                        const importedRecords = JSON.parse(decodeURIComponent(escape(atob(code))));
                        let added = 0;
                        importedRecords.forEach(rec => {
                            const exists = attendance.some(a => a.phone === rec.phone && a.date === targetDate);
                            if(!exists) {
                                attendance.push({ name: rec.name, phone: rec.phone, date: targetDate });
                                added++;
                            }
                        });
                        localStorage.setItem('attendance_data', JSON.stringify(attendance));
                        alert("تم الاستيراد بنجاح! تم إضافة " + added + " شخص ليوم " + targetDate);
                        closeModal('syncModal');
                    } catch(e) { alert("كود غير صالح!"); }
                };
            }
        }

        // الوظائف الأساسية
        async function startScanner() {
            const statusBox = document.getElementById('scanStatus');
            const readerDiv = document.getElementById("reader");
            if (html5QrCode) { try { await html5QrCode.stop(); } catch(e){} }
            readerDiv.innerHTML = "";
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => processAttendance(text))
            .then(() => { statusBox.innerText = "✅ الكاميرا تعمل"; statusBox.style.background = "#d4edda"; })
            .catch(() => { statusBox.innerText = "❌ خطأ في الكاميرا"; });
        }

        async function stopScanner() { if (html5QrCode && html5QrCode.isScanning) { await html5QrCode.stop(); html5QrCode = null; } }

        function processAttendance(phoneCode) {
            const date = document.getElementById('attendanceDate').value;
            const person = members.find(m => m.phone === phoneCode);
            if(!person) return;
            if(attendance.some(a => a.phone === phoneCode && a.date === date)) return;
            attendance.push({ name: person.name, phone: person.phone, date: date });
            localStorage.setItem('attendance_data', JSON.stringify(attendance));
            document.getElementById('successSound').play();
            loadTodayTable();
        }

        function renderAttendanceSummary(data) {
            const s = {};
            data.forEach(r => { if(!s[r.phone]) s[r.phone] = { name: r.name, count: 0, phone: r.phone }; s[r.phone].count++; });
            const sorted = Object.values(s).sort((a, b) => b.count - a.count);
            document.querySelector("#attendanceTable tbody").innerHTML = sorted.map(item => `
                <tr><td>${item.name}</td><td>${item.phone}</td><td><span class="count-link" onclick="showHistory('${item.phone}')">${item.count} أيام</span></td>
                <td><button class="del-btn" onclick="deleteFullHistory('${item.phone}')">🗑️</button></td></tr>`).join('');
        }

        function showHistory(p) {
            const person = members.find(m => m.phone === p);
            document.getElementById('historyOwnerName').innerText = person ? person.name : "التواريخ";
            document.querySelector("#personDatesTable tbody").innerHTML = attendance.filter(a => a.phone === p)
                .map(r => `<tr><td>${r.date}</td><td><button class="del-btn" onclick="deleteRecord('${p}','${r.date}')">🗑️</button></td></tr>`).join('');
            openModal('historyModal');
        }

        function addNewMember() {
            const n = document.getElementById('mName').value.trim(), p = document.getElementById('mPhone').value.trim();
            if(n && p) {
                if(members.some(m => m.phone === p)) return alert("مسجل مسبقاً");
                members.push({ name: n, phone: p });
                localStorage.setItem('church_members', JSON.stringify(members));
                document.getElementById('qrcode').innerHTML = "";
                new QRCode(document.getElementById("qrcode"), { text: p, width: 120, height: 120 });
                renderMembersTable();
                document.getElementById('mName').value = ""; document.getElementById('mPhone').value = "";
            }
        }

        function renderMembersTable() { 
            const q = document.getElementById('searchMembers').value.toLowerCase();
            const filtered = members.filter(m => m.name.toLowerCase().includes(q));
            document.getElementById('membersCount').innerText = `إجمالي المخدومين: ${members.length}`;
            document.querySelector("#membersTable tbody").innerHTML = filtered.map(m => `<tr><td>${m.name}</td><td><button class="del-btn" onclick="if(confirm('حذف؟')){members = members.filter(x=>x!==m);localStorage.setItem('church_members',JSON.stringify(members));renderMembersTable();}">🗑️</button></td></tr>`).join(''); 
        }

        function loadTodayTable() { 
            const d = document.getElementById('attendanceDate').value, q = document.getElementById('searchToday').value.toLowerCase();
            const filtered = attendance.filter(a => a.date === d && a.name.toLowerCase().includes(q));
            document.getElementById('presentCount').innerText = `عدد الحاضرين اليوم: ${attendance.filter(a => a.date === d).length}`;
            document.querySelector("#todayTable tbody").innerHTML = filtered.map(a => `<tr><td>${a.name}</td><td><button class="del-btn" onclick="deleteRecord('${a.phone}','${a.date}')">🗑️</button></td></tr>`).join(''); 
        }

        function renderAbsentList() {
            const d = document.getElementById('absentCheckDate').value, q = document.getElementById('searchAbsent').value.toLowerCase();
            if(!d) return;
            const present = attendance.filter(a => a.date === d).map(a => a.phone);
            const fullAbsent = members.filter(m => !present.includes(m.phone));
            const filtered = fullAbsent.filter(m => m.name.toLowerCase().includes(q));
            document.getElementById('absentCount').innerText = `عدد الغائبين: ${fullAbsent.length}`;
            document.querySelector("#absentTable tbody").innerHTML = filtered.map(m => `<tr><td>${m.name}</td><td>${m.phone}</td></tr>`).join('');
        }

        function deleteRecord(p, d) {
            if(confirm("حذف؟")) {
                attendance = attendance.filter(a => !(a.phone === p && a.date === d));
                localStorage.setItem('attendance_data', JSON.stringify(attendance));
                loadTodayTable(); renderAttendanceSummary(attendance);
            }
        }

        function filterManualList() { 
            const q = document.getElementById('manualSearch').value.toLowerCase(); 
            document.getElementById('namesList').innerHTML = members.filter(m => m.name.toLowerCase().includes(q)).map(m => `<option value="${m.phone}">${m.name}</option>`).join(''); 
        }
        function registerManual() { const p = document.getElementById('namesList').value; if(p) processAttendance(p); }

        function clearAttendanceData() {
            if(confirm("سيتم مسح كل سجلات الحضور!")) {
                attendance = [];
                localStorage.setItem('attendance_data', JSON.stringify(attendance));
                location.reload();
            }
        }

        setInterval(() => { 
            const opt = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            document.getElementById('clock').innerText = new Date().toLocaleString('ar-EG', opt); 
        }, 1000);
    </script>
</body>
</html>